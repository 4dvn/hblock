#!/usr/bin/env bash
# Author:
#  Héctor Molinero Fernández <me@znt.se>.
#

# Exit on errors:
set -eu
set -o pipefail

# Configuration:
DST_HOSTS='/etc/hosts'
DST_IP='0.0.0.0'
HEADER="
127.0.0.1       localhost $(uname -n)
255.255.255.255 broadcasthost
::1             localhost ip6-localhost ip6-loopback
fe00::0         ip6-localnet
ff00::0         ip6-mcastprefix
ff02::1         ip6-allnodes
ff02::2         ip6-allrouters
ff02::3         ip6-allhosts
"
SOURCES=(
	'http://adaway.org/hosts.txt'
	'http://hosts-file.net/ad_servers.txt'
	'http://malwaredomains.lehigh.edu/files/justdomains'
	'http://pgl.yoyo.org/adservers/serverlist.php?hostformat=nohtml&mimetype=plaintext'
	'http://someonewhocares.org/hosts/hosts'
	'http://winhelp2002.mvps.org/hosts.txt'
	'http://www.malwaredomainlist.com/hostslist/hosts.txt'
)
WHITELIST=(
# Regex examples:
#   '\.com$' -> all domains that ends with '.com'.
#   '^example' -> all domains that starts whith 'example'.
#   '^sub\.example\.org$' -> literal domain 'sub.example.org'.
	'^whitelistdomain1\.example$'
	'^whitelistdomain2\.example$'
)
BLACKLIST=(
# Literal string, no regex.
	'blacklistdomain.example'
)

# Messages:
actionMsg() {
	printf '\e[1;33m + \e[1;32m%s \e[0m\n' "$@"
}
infoMsg() {
	printf '   - %s\n' "$@"
}
errorMsg() {
	printf '\e[1;33m + \e[1;31m%s \e[0m\n' "$@"
}

# Process begins:
actionMsg 'Configuration:'
	infoMsg "Hosts location: $DST_HOSTS"
	infoMsg "Destination IP: $DST_IP"

BLOCKLIST=''

actionMsg 'Downloading lists...'
	for URL in "${SOURCES[@]}"; do
		infoMsg "$URL"
		CONTENT=$(curl -fsSL --connect-timeout 20 --max-time 60 "$URL") || true

		# Inform user if the download fails
		if [[ -z "$CONTENT" ]]; then
			errorMsg 'Error downloading lists'
			exit 1
		fi

		BLOCKLIST=$(printf '%s\n%s\n' "$BLOCKLIST" "$CONTENT")
		unset CONTENT
	done

actionMsg 'Parsing lists...'
	infoMsg 'Change EOL to Unix format'
		BLOCKLIST=$(printf '%s\n' "$BLOCKLIST" | sed 's/\r//g')

	infoMsg 'Select only hosts lines'
		IP_REGEX='([0-9]{1,3}\.){3}[0-9]{1,3}[[:space:]]+'
		DOMAIN_REGEX='([\p{L}0-9_-]{1,63}\.)+\p{L}[\p{L}0-9_-]{1,62}(?=[[:space:]#]|$)'
		BLOCKLIST=$(printf '%s\n' "$BLOCKLIST" | grep -Po "(^($IP_REGEX)|^)$DOMAIN_REGEX")

	infoMsg 'Remove old destination'
		BLOCKLIST=$(printf '%s\n' "$BLOCKLIST" | sed -r "s/^$IP_REGEX//g")

	infoMsg 'Transform all entries to lowercase'
		BLOCKLIST=$(printf '%s\n' "$BLOCKLIST" | awk '{print tolower($0)}')

	infoMsg 'Remove local entries'
		LOCAL_REGEX='(localhost|localhost\.localdomain|local|broadcasthost)'
		BLOCKLIST=$(printf '%s\n' "$BLOCKLIST" | sed -r "/^$LOCAL_REGEX$/d")

	infoMsg 'Apply whitelist'
		if [ ${#WHITELIST[@]} -gt 0 ]; then
			for DOMAIN in "${WHITELIST[@]}"; do
				BLOCKLIST=$(printf '%s\n' "$BLOCKLIST" | sed -r "/$DOMAIN/d")
			done
		fi

	infoMsg 'Apply blacklist'
		if [ ${#BLACKLIST[@]} -gt 0 ]; then
			for DOMAIN in "${BLACKLIST[@]}"; do
				BLOCKLIST=$(printf '%s\n%s\n' "$BLOCKLIST" "$DOMAIN")
			done
		fi

	infoMsg 'Remove duplicate entries'
		BLOCKLIST=$(printf '%s\n' "$BLOCKLIST" | awk '!a[$0]++')

	infoMsg 'Sort entries'
		BLOCKLIST=$(printf '%s\n' "$BLOCKLIST" | sort -n)

	infoMsg 'Add new destination'
		BLOCKLIST=$(printf '%s\n' "$BLOCKLIST" | sed "s/^/$DST_IP /g")

	actionMsg 'Generating hosts file...'
		HEADER=$(printf '# <header>%s# </header>\n' "$HEADER")
		HEADER=$(printf '# %s\n%s\n' "$(date --rfc-2822)" "$HEADER")
		HOSTS=$(printf '%s\n# <blocklist>\n%s\n# </blocklist>' "$HEADER" "$BLOCKLIST")

# Write to disk:
if [ $EUID -ne 0 ]; then
	printf '%s\n' "$HOSTS" | sudo tee "$DST_HOSTS" > /dev/null
else
	printf '%s\n' "$HOSTS" | tee "$DST_HOSTS" > /dev/null
fi

actionMsg "$(printf '%s\n' "$BLOCKLIST" | wc -l) hosts added!"
